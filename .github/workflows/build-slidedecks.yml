name: Build Slidedecks

on:
  pull_request:
    branches: [ "*" ]
  push:
    branches: [ "*" ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v5

    - name: Install node
      uses: actions/setup-node@v5
      with:
        node-version: '24.8.0'
        cache: 'npm'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
            libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev libpixman-1-dev \
            libatk1.0-0 libgtk-3-0 libnotify-dev libnss3 libxss1 libxtst6 xauth xvfb \
            xfonts-utils libasound2t64

    - name: Install npm dependencies
      run: npm ci

    - name: Install font
      run: |
        export PROJECT_ROOT=$PWD
        cd /tmp/
        tar xzvf $PROJECT_ROOT/stylesheet/nflx/font.tgz
        mkdir -p ~/.local/share/fonts
        cp -r package/fonts/*.ttf ~/.local/share/fonts
        chmod 755 ~/.local/share/fonts
        chmod 644 ~/.local/share/fonts/*.ttf
        fc-cache -f -v

    - name: Install chrome
      uses: browser-actions/setup-chrome@latest

    - name: Build slidedecks and stage pages
      run: npm run :build

    - name: Deploy Github Pages
      uses: JamesIves/github-pages-deploy-action@v4.7.3
      if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
      with:
        branch: gh-pages
        folder: pages/build/staging
